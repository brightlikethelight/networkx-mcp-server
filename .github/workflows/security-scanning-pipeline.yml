name: Advanced Security Scanning Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 3 * * *'  # Daily security scan at 3 AM UTC
  workflow_dispatch:
    inputs:
      deep_scan:
        description: 'Run deep security analysis'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  security-events: write
  issues: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'

jobs:
  # 1. Dependency Vulnerability Scanning
  dependency-scan:
    name: Dependency Vulnerability Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      # Safety - Python dependency scanner
      - name: Safety Check
        run: |
          pip install safety
          safety check --json --output safety-report.json || true
          
          # Parse and report critical vulnerabilities
          python -c "
          import json
          with open('safety-report.json') as f:
              report = json.load(f)
          
          critical_vulns = [v for v in report.get('vulnerabilities', []) 
                           if v.get('severity', '').lower() in ['critical', 'high']]
          
          if critical_vulns:
              print('ðŸš¨ Critical vulnerabilities found:')
              for vuln in critical_vulns:
                  print(f\"  - {vuln.get('package_name')}: {vuln.get('vulnerability_id')}\")
              exit(1)
          else:
              print('âœ… No critical vulnerabilities found')
          " || echo "::warning::Critical vulnerabilities detected"
      
      # pip-audit - Another Python scanner
      - name: Pip Audit
        run: |
          pip install pip-audit
          pip-audit --desc --format json --output pip-audit-report.json || true
      
      # Snyk scanning
      - name: Snyk Security Scan
        uses: snyk/actions/python@master
        continue-on-error: true
        with:
          args: --severity-threshold=high --json-file-output=snyk-report.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      
      # OWASP Dependency Check
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'networkx-mcp-server'
          path: '.'
          format: 'JSON'
          args: >
            --enableRetired
            --enableExperimental
            --suppression owasp-suppressions.xml
      
      - name: Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-results
          path: |
            safety-report.json
            pip-audit-report.json
            snyk-report.json
            reports/dependency-check-report.json

  # 2. Static Application Security Testing (SAST)
  sast-scan:
    name: Static Application Security Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Semgrep - Advanced SAST
      - name: Semgrep Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/python
            p/owasp-top-ten
            p/r2c-security-audit
            p/django
            p/flask
      
      # Bandit - Python security linter
      - name: Bandit Security Scan
        run: |
          pip install bandit[toml]
          bandit -r src/ -f json -o bandit-report.json --severity-level medium || true
          
          # Generate actionable report
          python -c "
          import json
          with open('bandit-report.json') as f:
              report = json.load(f)
          
          issues = report.get('results', [])
          high_severity = [i for i in issues if i.get('issue_severity') == 'HIGH']
          
          if high_severity:
              print('ðŸ”´ High severity issues found:')
              for issue in high_severity[:5]:  # Top 5
                  print(f\"  - {issue.get('issue_text')} at {issue.get('filename')}:{issue.get('line_number')}\")
          "
      
      # CodeQL Advanced Queries
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: +security-extended,security-and-quality
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"
      
      # Custom security patterns
      - name: Custom Security Pattern Scan
        run: |
          cat > security-patterns.yml << 'EOF'
          rules:
            - id: hardcoded-secret
              pattern: |
                $KEY = "..."
              message: "Potential hardcoded secret"
              languages: [python]
              severity: ERROR
            
            - id: sql-injection
              patterns:
                - pattern: |
                    $QUERY = "..." % $INPUT
                - pattern: |
                    $QUERY = "...".format($INPUT)
              message: "Potential SQL injection"
              languages: [python]
              severity: ERROR
            
            - id: command-injection
              patterns:
                - pattern: os.system($INPUT)
                - pattern: subprocess.call($INPUT, shell=True)
              message: "Potential command injection"
              languages: [python]
              severity: ERROR
          EOF
          
          pip install semgrep
          semgrep --config=security-patterns.yml src/ --json -o custom-scan.json || true

  # 3. Secret Scanning
  secret-scan:
    name: Secret and Credential Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning
      
      # TruffleHog - Secret scanner
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --json --only-verified
      
      # Gitleaks - Another secret scanner
      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # detect-secrets
      - name: Detect Secrets
        run: |
          pip install detect-secrets
          detect-secrets scan --baseline .secrets.baseline || true
          detect-secrets audit .secrets.baseline || echo "::warning::Potential secrets detected"

  # 4. Container Security Scanning
  container-scan:
    name: Container Security Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.deep_scan == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Container Image
        run: |
          docker build -t ${{ github.repository }}:scan .
      
      # Trivy - Container scanner
      - name: Trivy Container Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ github.repository }}:scan
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          vuln-type: 'os,library'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
      
      # Grype - Alternative container scanner
      - name: Grype Container Scan
        uses: anchore/scan-action@v3
        with:
          image: ${{ github.repository }}:scan
          fail-build: false
          output-format: sarif
      
      # Docker Scout
      - name: Docker Scout Analysis
        if: github.event.inputs.deep_scan == 'true'
        run: |
          docker scout cves ${{ github.repository }}:scan --format json > scout-report.json || true
          docker scout recommendations ${{ github.repository }}:scan || true

  # 5. Infrastructure as Code Security
  iac-scan:
    name: Infrastructure as Code Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Checkov - IaC scanner
      - name: Checkov IaC Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          quiet: false
          soft_fail: true
          framework: all
          output_format: sarif
          output_file_path: checkov-results.sarif
      
      # Terrascan
      - name: Terrascan IaC Scan
        run: |
          docker run --rm -v "$(pwd):/src" \
            tenable/terrascan scan -t docker,k8s,github \
            -f json -o terrascan-report.json || true
      
      # KICS - Keeping Infrastructure as Code Secure
      - name: KICS Security Scan
        uses: checkmarx/kics-github-action@v1.7.0
        with:
          path: .
          output_path: kics-results
          output_formats: 'json,sarif'
          fail_on: high
          enable_comments: true

  # 6. License Compliance Check
  license-check:
    name: License Compliance Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: License Finder
        run: |
          pip install pip-licenses
          pip-licenses --format=json --output-file=licenses.json
          
          # Check for problematic licenses
          python -c "
          import json
          
          ALLOWED_LICENSES = [
              'MIT', 'Apache-2.0', 'BSD-3-Clause', 'BSD-2-Clause',
              'ISC', 'Python-2.0', 'PSF', 'LGPL-2.1', 'LGPL-3.0'
          ]
          
          FORBIDDEN_LICENSES = ['GPL-3.0', 'AGPL-3.0', 'SSPL']
          
          with open('licenses.json') as f:
              licenses = json.load(f)
          
          problems = []
          for pkg in licenses:
              license = pkg.get('License', 'Unknown')
              if any(forbidden in license for forbidden in FORBIDDEN_LICENSES):
                  problems.append(f\"{pkg['Name']}: {license} (FORBIDDEN)\")
              elif not any(allowed in license for allowed in ALLOWED_LICENSES):
                  problems.append(f\"{pkg['Name']}: {license} (UNKNOWN)\")
          
          if problems:
              print('âš ï¸ License compliance issues:')
              for problem in problems:
                  print(f'  - {problem}')
              exit(1)
          else:
              print('âœ… All licenses compliant')
          "

  # 7. SBOM Generation
  sbom-generation:
    name: Software Bill of Materials
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate SBOM (CycloneDX)
        run: |
          pip install cyclonedx-bom
          cyclonedx-py -r -i requirements.txt \
            -o sbom-cyclonedx.json --format json
          cyclonedx-py -r -i requirements.txt \
            -o sbom-cyclonedx.xml --format xml
      
      - name: Generate SBOM (SPDX)
        run: |
          pip install spdx-tools
          python -c "
          from spdx_tools.spdx.model import Document, CreationInfo, Package
          from spdx_tools.spdx.writer.write_anything import write_file
          from datetime import datetime
          
          doc = Document(
              spdx_version='SPDX-2.3',
              spdx_id='SPDXRef-DOCUMENT',
              name='networkx-mcp-server-sbom',
              document_namespace='https://github.com/${{ github.repository }}',
              creation_info=CreationInfo(
                  created=datetime.now(),
                  creators=['Tool: GitHub Actions'],
                  license_list_version='3.20'
              ),
              packages=[]
          )
          
          write_file(doc, 'sbom-spdx.json', data_format='json')
          "
      
      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-artifacts
          path: |
            sbom-cyclonedx.json
            sbom-cyclonedx.xml
            sbom-spdx.json

  # 8. Security Report Aggregation
  security-report:
    name: Security Report Generation
    runs-on: ubuntu-latest
    needs: [dependency-scan, sast-scan, secret-scan, container-scan, iac-scan, license-check, sbom-generation]
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-artifacts
      
      - name: Generate Consolidated Report
        run: |
          cat > security-report.md << 'EOF'
          # Security Scan Report
          
          **Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Repository**: ${{ github.repository }}
          **Branch**: ${{ github.ref }}
          **Commit**: ${{ github.sha }}
          
          ## Summary
          
          | Scan Type | Status | Critical | High | Medium | Low |
          |-----------|--------|----------|------|--------|-----|
          | Dependencies | ${{ needs.dependency-scan.result }} | - | - | - | - |
          | SAST | ${{ needs.sast-scan.result }} | - | - | - | - |
          | Secrets | ${{ needs.secret-scan.result }} | - | - | - | - |
          | Container | ${{ needs.container-scan.result }} | - | - | - | - |
          | IaC | ${{ needs.iac-scan.result }} | - | - | - | - |
          | Licenses | ${{ needs.license-check.result }} | - | - | - | - |
          
          ## Recommendations
          
          1. Review and remediate all critical and high severity findings
          2. Update dependencies with known vulnerabilities
          3. Rotate any exposed secrets immediately
          4. Apply security patches to container base images
          5. Review and fix Infrastructure as Code issues
          
          ## Detailed Reports
          
          Detailed reports are available in the workflow artifacts.
          
          ---
          *Generated by NetworkX MCP Server Security Pipeline*
          EOF
          
          echo "Security report generated"
      
      - name: Post PR Comment (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
      
      - name: Create Security Issue (if critical)
        if: |
          needs.dependency-scan.result == 'failure' ||
          needs.sast-scan.result == 'failure' ||
          needs.secret-scan.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Critical Security Issues Detected',
              body: `Critical security issues were detected in the security scan.
              
              **Workflow Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              Please review the security reports and take immediate action.`,
              labels: ['security', 'critical', 'automated']
            });