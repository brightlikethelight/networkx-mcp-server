# Consolidated Monitoring and Alerting Pipeline
# Provides unified CI health monitoring via scheduled checks

name: Monitoring

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # CI Health Dashboard
  health-dashboard:
    name: CI Health Dashboard
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Analyze Workflow Status
        id: analyze
        run: |
          echo "## CI/CD Health Report" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          check_workflow() {
            local workflow_name="$1"
            local workflow_file="$2"

            run_info=$(gh run list --workflow="$workflow_file" --limit=1 --json status,conclusion,createdAt 2>/dev/null)

            if [ -z "$run_info" ] || [ "$run_info" = "[]" ]; then
              echo "âš ï¸ **$workflow_name**: No recent runs" >> $GITHUB_STEP_SUMMARY
              return 1
            fi

            conclusion=$(echo "$run_info" | jq -r '.[0].conclusion')

            if [ "$conclusion" = "success" ]; then
              echo "âœ… **$workflow_name**: Passing" >> $GITHUB_STEP_SUMMARY
            elif [ "$conclusion" = "failure" ]; then
              echo "âŒ **$workflow_name**: Failed" >> $GITHUB_STEP_SUMMARY
              echo "failure" >> workflow_failures.txt
            else
              echo "âš ï¸ **$workflow_name**: $conclusion" >> $GITHUB_STEP_SUMMARY
            fi
          }

          echo "### Workflow Status" >> $GITHUB_STEP_SUMMARY
          check_workflow "CI" "ci.yml"
          check_workflow "Security" "security.yml"
          check_workflow "Docker Build" "docker-build.yml"
          check_workflow "Documentation" "docs.yml"

          failure_count=0
          if [ -f workflow_failures.txt ]; then
            failure_count=$(wc -l < workflow_failures.txt)
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Overall Health" >> $GITHUB_STEP_SUMMARY

          if [ "$failure_count" -eq 0 ]; then
            echo "ðŸŸ¢ **Status: Healthy** - All workflows passing" >> $GITHUB_STEP_SUMMARY
            echo "health=healthy" >> $GITHUB_OUTPUT
          elif [ "$failure_count" -le 2 ]; then
            echo "ðŸŸ¡ **Status: Degraded** - $failure_count workflow(s) failing" >> $GITHUB_STEP_SUMMARY
            echo "health=degraded" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”´ **Status: Critical** - $failure_count workflow(s) failing" >> $GITHUB_STEP_SUMMARY
            echo "health=critical" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create Issue for Critical Failures
        if: steps.analyze.outputs.health == 'critical'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-health-alert'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ CI/CD Health Alert: Critical Status',
                body: `## Automated CI/CD Health Alert

            The CI/CD pipeline health monitor has detected critical failures.

            **Status:** ðŸ”´ Critical
            **Time:** ${new Date().toUTCString()}

            Please check the [workflow summary](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.

            ### Required Actions
            - [ ] Review failing workflows
            - [ ] Fix critical issues
            - [ ] Verify fixes are deployed

            ---
            *This issue was automatically created by the monitoring workflow.*`,
                labels: ['ci-health-alert', 'automated']
              });
            }
