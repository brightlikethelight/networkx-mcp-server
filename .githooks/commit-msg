#!/bin/bash
# Commit message validation hook for NetworkX MCP Server
# Enforces conventional commits specification

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Read the commit message
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if [ "$(git rev-parse --verify HEAD 2>/dev/null)" != "" ]; then
    if git rev-parse --verify MERGE_HEAD >/dev/null 2>&1; then
        exit 0
    fi
fi

echo "üîç Validating commit message..."

# Conventional commit regex pattern
# Format: <type>(<scope>): <subject>
#         [blank line]
#         [optional body]
#         [optional footer(s)]
CONVENTIONAL_COMMIT_REGEX="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z][a-z0-9\-\/]*\))?: .{1,72}$"

# Get the first line of the commit message
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)

# Check if the first line matches conventional commit format
if ! echo "$FIRST_LINE" | grep -qE "$CONVENTIONAL_COMMIT_REGEX"; then
    echo -e "${RED}‚ùå Invalid commit message format!${NC}"
    echo ""
    echo -e "${YELLOW}The first line of your commit message does not follow the Conventional Commits specification.${NC}"
    echo ""
    echo "Expected format:"
    echo -e "${BLUE}  <type>(<scope>): <subject>${NC}"
    echo ""
    echo "Valid types:"
    echo "  - feat:     A new feature"
    echo "  - fix:      A bug fix"
    echo "  - docs:     Documentation only changes"
    echo "  - style:    Changes that don't affect code meaning (formatting, etc)"
    echo "  - refactor: Code change that neither fixes a bug nor adds a feature"
    echo "  - perf:     Code change that improves performance"
    echo "  - test:     Adding or correcting tests"
    echo "  - build:    Changes to build system or dependencies"
    echo "  - ci:       Changes to CI configuration files and scripts"
    echo "  - chore:    Other changes that don't modify src or test files"
    echo "  - revert:   Reverts a previous commit"
    echo ""
    echo "Valid scopes (optional):"
    echo "  - monitoring: Monitoring and observability features"
    echo "  - ci/cd:      CI/CD pipeline and workflows"
    echo "  - core:       Core graph operations"
    echo "  - mcp:        MCP protocol implementation"
    echo "  - tools:      MCP tools and utilities"
    echo "  - deps:       Dependencies and requirements"
    echo "  - security:   Security-related changes"
    echo "  - academic:   Academic features"
    echo ""
    echo "Examples:"
    echo -e "${GREEN}  feat(monitoring): add webhook integration for CI alerts${NC}"
    echo -e "${GREEN}  fix(ci/cd): resolve Windows path issues in tests${NC}"
    echo -e "${GREEN}  docs: update README with installation instructions${NC}"
    echo ""
    echo "Your commit message:"
    echo -e "${RED}  $FIRST_LINE${NC}"
    echo ""
    exit 1
fi

# Check commit message length (first line should be <= 72 characters)
FIRST_LINE_LENGTH=${#FIRST_LINE}
if [ $FIRST_LINE_LENGTH -gt 72 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: First line is $FIRST_LINE_LENGTH characters (recommended: ‚â§72)${NC}"
    echo "Consider making the subject line more concise."
fi

# Extract commit type and scope
COMMIT_TYPE=$(echo "$FIRST_LINE" | sed -E 's/^([a-z]+)(\([a-z][a-z0-9\-\/]*\))?: .*/\1/')
COMMIT_SCOPE=$(echo "$FIRST_LINE" | sed -E 's/^[a-z]+\(([a-z][a-z0-9\-\/]*)\): .*/\1/')
COMMIT_SUBJECT=$(echo "$FIRST_LINE" | sed -E 's/^[a-z]+(\([a-z][a-z0-9\-\/]*\))?: (.*)/\2/')

# Check for empty subject
if [ -z "$COMMIT_SUBJECT" ] || [ "$COMMIT_SUBJECT" = " " ]; then
    echo -e "${RED}‚ùå Commit subject cannot be empty!${NC}"
    exit 1
fi

# Check if subject starts with capital letter (should be lowercase)
if echo "$COMMIT_SUBJECT" | grep -qE "^[A-Z]"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Subject should start with lowercase letter${NC}"
    echo "  Current: $COMMIT_SUBJECT"
    echo "  Better:  $(echo "$COMMIT_SUBJECT" | sed 's/^./\L&/')"
fi

# Check if subject ends with period (should not)
if echo "$COMMIT_SUBJECT" | grep -qE "\.$"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Subject should not end with a period${NC}"
fi

# Check for BREAKING CHANGE in footer
if echo "$COMMIT_MSG" | grep -q "BREAKING CHANGE:"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Breaking change detected!${NC}"
    echo "Make sure to:"
    echo "  1. Update the major version number"
    echo "  2. Document migration steps"
    echo "  3. Update CHANGELOG.md"
fi

# Check for issue references
if echo "$COMMIT_MSG" | grep -qE "(Closes|Fixes|Resolves) #[0-9]+"; then
    echo -e "${GREEN}‚úÖ Issue reference found${NC}"
fi

# Check body format (if present)
BODY_LINES=$(echo "$COMMIT_MSG" | tail -n +3)
if [ ! -z "$BODY_LINES" ] && [ "$BODY_LINES" != "" ]; then
    # Check if there's a blank line between subject and body
    SECOND_LINE=$(echo "$COMMIT_MSG" | sed -n '2p')
    if [ ! -z "$SECOND_LINE" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Warning: Missing blank line between subject and body${NC}"
    fi

    # Check body line length (should wrap at 72 characters)
    echo "$BODY_LINES" | while IFS= read -r line; do
        if [ ${#line} -gt 72 ] && ! echo "$line" | grep -qE "^(https?://|Closes|Fixes|Resolves|BREAKING CHANGE:)"; then
            echo -e "${YELLOW}‚ö†Ô∏è  Warning: Body line exceeds 72 characters${NC}"
            echo "  Line: $(echo "$line" | cut -c1-50)..."
        fi
    done
fi

# Provide commit statistics
echo ""
echo -e "${BLUE}üìä Commit Statistics:${NC}"
echo "  Type: $COMMIT_TYPE"
if [ "$COMMIT_SCOPE" != "$COMMIT_TYPE" ]; then
    echo "  Scope: $COMMIT_SCOPE"
fi
echo "  Subject length: $FIRST_LINE_LENGTH characters"
TOTAL_LINES=$(echo "$COMMIT_MSG" | wc -l)
echo "  Total lines: $TOTAL_LINES"

# Check for specific patterns that indicate good practices
GOOD_PRACTICES=0

# Check for "why" explanation in body
if echo "$BODY_LINES" | grep -qiE "(because|reason|why|in order to|so that)"; then
    echo -e "${GREEN}  ‚úÖ Explains why the change was made${NC}"
    GOOD_PRACTICES=$((GOOD_PRACTICES + 1))
fi

# Check for test mentions
if echo "$COMMIT_MSG" | grep -qiE "(test|spec|coverage)"; then
    echo -e "${GREEN}  ‚úÖ Mentions testing${NC}"
    GOOD_PRACTICES=$((GOOD_PRACTICES + 1))
fi

# Check for documentation mentions
if echo "$COMMIT_MSG" | grep -qiE "(docs|documentation|readme|changelog)"; then
    echo -e "${GREEN}  ‚úÖ Mentions documentation${NC}"
    GOOD_PRACTICES=$((GOOD_PRACTICES + 1))
fi

# Overall assessment
echo ""
if [ $GOOD_PRACTICES -ge 2 ]; then
    echo -e "${GREEN}‚ú® Excellent commit message!${NC}"
elif [ $GOOD_PRACTICES -ge 1 ]; then
    echo -e "${GREEN}‚úÖ Good commit message!${NC}"
else
    echo -e "${GREEN}‚úÖ Valid commit message${NC}"
fi

exit 0
