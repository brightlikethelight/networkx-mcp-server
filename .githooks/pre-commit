#!/bin/bash
# Pre-commit hook for NetworkX MCP Server
# Ensures code quality before allowing commits

set -e

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any checks fail
FAILED=0

# Function to print colored output
print_status() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}‚úÖ $2${NC}"
    else
        echo -e "${RED}‚ùå $2${NC}"
        FAILED=1
    fi
}

# 1. Check for debugging artifacts
echo "Checking for debugging artifacts..."
if git diff --cached --name-only | xargs grep -l "import pdb\|pdb.set_trace\|console.log\|debugger\|print(" 2>/dev/null; then
    echo -e "${RED}‚ùå Found debugging statements in staged files${NC}"
    echo "Please remove debugging code before committing."
    FAILED=1
else
    echo -e "${GREEN}‚úÖ No debugging artifacts found${NC}"
fi

# 2. Check for sensitive information
echo "Checking for sensitive information..."
SENSITIVE_PATTERNS="password\|secret\|token\|api[_-]key\|apikey\|AWS_ACCESS_KEY\|AWS_SECRET"
if git diff --cached --name-only | xargs grep -iE "$SENSITIVE_PATTERNS" 2>/dev/null | grep -v "# noqa: S"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Potential sensitive information detected${NC}"
    echo "Please review the above matches and ensure no secrets are being committed."
    read -p "Continue with commit? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# 3. Run ruff formatting check
echo "Checking code formatting with ruff..."
if command -v ruff &> /dev/null; then
    ruff format --check . &>/dev/null
    print_status $? "Code formatting (ruff)"
    
    if [ $? -ne 0 ]; then
        echo "Run 'ruff format .' to fix formatting issues"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  ruff not installed - skipping format check${NC}"
fi

# 4. Run ruff linting
echo "Running linter checks..."
if command -v ruff &> /dev/null; then
    ruff check . --quiet
    print_status $? "Linting (ruff)"
    
    if [ $? -ne 0 ]; then
        echo "Run 'ruff check . --fix' to fix some issues automatically"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  ruff not installed - skipping lint check${NC}"
fi

# 5. Run type checking with mypy
echo "Running type checks..."
if command -v mypy &> /dev/null; then
    mypy src/networkx_mcp/ --ignore-missing-imports --no-error-summary 2>&1 | grep -E "error:" > /dev/null
    if [ $? -eq 0 ]; then
        print_status 1 "Type checking (mypy)"
        echo "Run 'mypy src/networkx_mcp/' to see type errors"
    else
        print_status 0 "Type checking (mypy)"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  mypy not installed - skipping type check${NC}"
fi

# 6. Run security checks with bandit
echo "Running security checks..."
if command -v bandit &> /dev/null; then
    bandit -r src/networkx_mcp/ -ll --quiet 2>/dev/null
    print_status $? "Security scan (bandit)"
else
    echo -e "${YELLOW}‚ö†Ô∏è  bandit not installed - skipping security check${NC}"
fi

# 7. Check file sizes
echo "Checking file sizes..."
LARGE_FILES=$(git diff --cached --name-only | xargs -I {} sh -c 'test -f "{}" && stat -f%z "{}" 2>/dev/null || stat -c%s "{}" 2>/dev/null' | awk '$1 > 1048576')
if [ ! -z "$LARGE_FILES" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Large files detected (>1MB)${NC}"
    git diff --cached --name-only | xargs -I {} sh -c 'test -f "{}" && ls -lh "{}"' | awk '$5 ~ /[0-9]+M/'
    read -p "Continue with large files? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# 8. Run tests for changed files
echo "Running tests for changed files..."
CHANGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' | grep -v '__pycache__')
if [ ! -z "$CHANGED_PY_FILES" ]; then
    if command -v pytest &> /dev/null; then
        # Run only tests related to changed files
        TEST_FILES=""
        for file in $CHANGED_PY_FILES; do
            # Find corresponding test file
            test_file=$(echo $file | sed 's/src\/networkx_mcp/tests/' | sed 's/\.py$/_test.py/')
            if [ -f "$test_file" ]; then
                TEST_FILES="$TEST_FILES $test_file"
            fi
        done
        
        if [ ! -z "$TEST_FILES" ]; then
            pytest $TEST_FILES --quiet --tb=no
            print_status $? "Related tests"
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  pytest not installed - skipping test check${NC}"
    fi
fi

# 9. Check Python syntax
echo "Checking Python syntax..."
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$')
if [ ! -z "$PYTHON_FILES" ]; then
    for file in $PYTHON_FILES; do
        python -m py_compile "$file" 2>/dev/null
        if [ $? -ne 0 ]; then
            echo -e "${RED}‚ùå Syntax error in $file${NC}"
            FAILED=1
        fi
    done
    if [ $FAILED -eq 0 ]; then
        echo -e "${GREEN}‚úÖ Python syntax check passed${NC}"
    fi
fi

# 10. Check for merge conflicts
echo "Checking for merge conflict markers..."
if git diff --cached --name-only | xargs grep -E "^(<<<<<<<|=======|>>>>>>>)" 2>/dev/null; then
    echo -e "${RED}‚ùå Merge conflict markers found${NC}"
    FAILED=1
else
    echo -e "${GREEN}‚úÖ No merge conflict markers${NC}"
fi

# Final status
echo ""
if [ $FAILED -ne 0 ]; then
    echo -e "${RED}‚ùå Pre-commit checks failed!${NC}"
    echo "Please fix the issues above and try again."
    exit 1
else
    echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
fi

exit 0